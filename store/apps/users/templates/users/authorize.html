{# --"--\Catalog\store\apps\users\templates\users\authorize.html"-- #}
{% extends 'base.html' %}
{% load i18n static compress %}
{% block title %}
  {% trans "Login / Registration" %}
{% endblock title %}
{% block css %}
  {% compress css %}
    <link rel="stylesheet"
          href="{% static 'scss/users.scss' %}"
          type="text/x-scss">
  {% endcompress %}
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
{% endblock css %}
{% block content %}
  <section>
    <div class="container">
      <div class="auth-container">
        <div class="auth-tabs">
          <button class="auth-tab {% if active_form == 'login' %}active{% endif %}"
                  data-form="login-form">{% trans "Login" %}</button>
          <button class="auth-tab {% if active_form == 'register' %}active{% endif %}"
                  data-form="register-form">{% trans "Registration" %}</button>
          <div class="tab-indicator"></div>
        </div>
        {# --- Login Form --- #}
        <form id="login-form"
              class="auth-form {% if active_form == 'login' %}active{% endif %}"
              method="post"
              action="{% url 'users:authorize' %}"
              novalidate>
          {% csrf_token %}
          <input type="hidden" name="form_type" value="login">
          <input type="hidden" name="next" value="{{ next }}">
          {# Generic non-field errors (e.g., authentication failed) #}
          {% if login_form.non_field_errors %}
            <div class="form-error-generic">
              {% for error in login_form.non_field_errors %}{{ error }}{% endfor %}
            </div>
          {% endif %}
          {% for field in login_form %}
            {# Render the field using its widget template #}
            {{ field }}
            {# Display Django field errors *after* the field is rendered #}
            {% if field.errors %}
              {# This wrapper div will be styled by the new CSS rules #}
              <div class="django-field-error">
                {{ field.errors }} {# Django renders ul.errorlist here #}
              </div>
            {% endif %}
            {# Special handling for forgot password link (placed outside form-field) #}
            {% if field.name == 'remember_me' %}
              <div class="form-field-extra"
                   style="text-align: right;
                          margin-top: -1rem;
                          margin-bottom: 1.5rem">
                <a href="{% url 'users:password_reset' %}" class="auth-link">{% trans "Forgot password?" %}</a>
              </div>
            {% endif %}
          {% endfor %}
          <button type="submit" class="auth-button">
            <i class="fas fa-sign-in-alt"></i> {% trans "Login" %}
          </button>
          <p class="auth-switch-text">
            {% trans "No account?" %} <a href="#" class="auth-link" data-switch-tab="register-form">{% trans "Register" %}</a>
          </p>
        </form>
        {# --- Registration Form --- #}
        <form id="register-form"
              class="auth-form {% if active_form == 'register' %}active{% endif %}"
              method="post"
              action="{% url 'users:authorize' %}"
              novalidate>
          {% csrf_token %}
          <input type="hidden" name="form_type" value="register">
          <input type="hidden" name="next" value="{{ next }}">
          {# Generic non-field errors #}
          {% if register_form.non_field_errors %}
            <div class="form-error-generic">
              {% for error in register_form.non_field_errors %}{{ error }}{% endfor %}
            </div>
          {% endif %}
          {% for field in register_form %}
            {# Render the field using its widget template #}
            {{ field }}
            {# Display Django field errors *after* the field is rendered #}
            {% if field.errors %}
              {# This wrapper div will be styled by the new CSS rules #}
              <div class="django-field-error">
                {{ field.errors }} {# Django renders ul.errorlist here #}
              </div>
            {% endif %}
          {% endfor %}
          <button type="submit" class="auth-button">
            <i class="fas fa-user-plus"></i> {% trans "Register" %}
          </button>
          <p class="auth-switch-text">
            {% trans "Already have an account?" %} <a href="#" class="auth-link" data-switch-tab="login-form">{% trans "Login" %}</a>
          </p>
        </form>
      </div>
    </div>
  </section>
{% endblock content %}
{% block show_footer %}
  {% include 'include/footer.html' %}
{% endblock show_footer %}
{% block extra_js %}
  <script type="module" src="{% static 'js/widgets/init.js' %}"></script>
  <script>
    // Keep the tab switching logic
    document.addEventListener('DOMContentLoaded', () => {
      const tabs = document.querySelectorAll('.auth-tab');
      const forms = document.querySelectorAll('.auth-form');
      const switchLinks = document.querySelectorAll('.auth-link[data-switch-tab]');
      const tabIndicator = document.querySelector('.tab-indicator');

      function updateTabIndicator(activeTab) {
        if (!tabIndicator || !activeTab || window.innerWidth <= 480) return;
        tabIndicator.style.width = `${activeTab.offsetWidth}px`;
        tabIndicator.style.left = `${activeTab.offsetLeft}px`;
        requestAnimationFrame(() => {
            tabIndicator.style.transition = 'left 0.3s cubic-bezier(0.645, 0.045, 0.355, 1), width 0.3s cubic-bezier(0.645, 0.045, 0.355, 1)';
        });
      }

      function setActiveTab(targetFormId) {
        const activeTab = document.querySelector(`.auth-tab[data-form="${targetFormId}"]`);
        if (!activeTab) return;

        tabs.forEach(tab => tab.classList.toggle('active', tab === activeTab));
        forms.forEach(form => {
          const isActive = form.id === targetFormId;
          form.classList.toggle('active', isActive);
        });
        updateTabIndicator(activeTab);
      }

      const initialActiveTab = document.querySelector('.auth-tab.active');
      if (initialActiveTab) {
         setTimeout(() => updateTabIndicator(initialActiveTab), 50);
      }
      window.addEventListener('resize', () => {
        const currentActiveTab = document.querySelector('.auth-tab.active');
        if (currentActiveTab) updateTabIndicator(currentActiveTab);
      });

      tabs.forEach(tab => tab.addEventListener('click', () => setActiveTab(tab.getAttribute('data-form'))));
      switchLinks.forEach(link => link.addEventListener('click', (e) => {
        e.preventDefault();
        setActiveTab(link.getAttribute('data-switch-tab'));
      }));
    });
  </script>
{% endblock extra_js %}